#Lab3 report
##练习1:给未被映射的地址映射上物理页(需要编程)
- 完成do_pgfault(mm/vmm.c)函数,给未被映射的地址映射上物理页.设置访问权限的时候需要参考页面所在VMA的权限,同时需要注意映射物理页时需要操作内存控制控制结构所指定的页表,而不是内核的页表.
- 请在实验报告中简要说明你的设计实现过程。请回答如下问题:
- 请描述页目录项(Pag Director Entry)和页表(Page Table Entry)中组成部分对ucore实现页替换算法的潜在用处。
- 页目录项和页表项有32位字长。组成部分有：
-		PTE_P(第0位)	0x001	表示物理页是否存在
-		PTE_W（第1位）	0x002	表示是否可写
-		PTE_U（第3位）	0x004	表示是否用户可用
-		PTE_PWT（第4位） 0x008	表示是否为写达
-		PTE_PCD(第5位)   0x010	表示不使用Cache高速缓存
-		PTE_A(第6位)     0x020	表示是否可访问
-		PTE_D（第7位）   0x040	表示是否脏页
-		PTE_PS(第8位)    0x080	表示页面大小
-		PTE_MBZ（第16位）0x180 	必须为0
-		PTE_AVAIL       0xE00  	表示能否被应用软件使用 
-		这些标志位可以帮助操作系统更有效地管理这些物理页。
- 如果ucore的缺页服务例程在执行过程中访问内存,出现了页访问异常,请问硬件要做哪些事情?
-	CPU在当前内核栈保存当前被打断的程序现场,即依次压入当前被打断程序使用的EFLAGS,CS,EIP,errorCode;
-        由于页访问异常的中断号是0xE,CPU把异常中断号0xE对应的中断服务例程的地址(vectors.S中的标号vector14处)加载到CS和EIP寄存- 器中,开始执行中断服务例程。   
-        这时ucore开始处理异常中断,首先需要保存硬件没有保存的寄存器。在vectors.S中的标号vector14处先把中断号压入内核栈,然后再- 在trapentry.S中的标号 __alltraps处把DS、ES和其他通用寄存器都压栈。自此,被打断的程序执行现场(context)被保存在内核栈中。接下
-        来,在trap.c的trap函数开始了中断服务例程的处理流程ucore中do_pgfault函数是完成页访问异常处理的主要函数,它根据从CPU的控- 制寄存器CR2中获取的页访问异常的物理地址
-       以及根据errorCode的错误类型来查找此地址是否在某个VMA的地址范围内以及是否满足正确的读写权限,如果在此范围内
-       并且权限也正确,这认为这是一次合法访问,但没有建立虚实对应关系。所以需要分配一个空闲的内存页,并修改页表完成
-        虚地址到物理地址的映射,刷新TLB,然后调用iret中断,返回到产生页访问异常的指令处重新执行此指令。如果该虚地址不
-        在某VMA范围内,则认为是一次非法访问。从idt表中查找到该异常处理例程的入口地址，跳转到异常处理例程入口，开始处理页访问
-        异常。处理结束之后,
- 设计实现过程:
-	试着找到虚拟地址addr对应页表项,若该页表项的页表	不存在创将一个页表.
-	若物理地址不存在,在分配一个页并且建立与逻辑地址的映射关系.
-	否则,我们就认为该页表项是一个可交换项,从硬盘中载入数据到这个物理地址所在的页面, 
-	建立物理地址与逻辑地址之间的映射关系.将该页加入到页目录表中,加入到可交换页的队列中去.
##练习2:补充完成基于FIFO的页面替换算法(需要编程)
- 完成vmm.c中的do_pgfault函数,并且在实现FIFO算法的swap_fifo.c中完成map_swappable和swap_out_vistim函数。请在实验报告中简要说明- 你的设计实现过程。
- 请在实验报告中回答如下问题:
- 如果要在ucore上实现"extended clock页替换算法"请给你的设计方案,现有的swap_manager框架是否足以支持在ucore
- 中实现此算法?如果是,请给你的设计方案。如果不是,请给出你的新的扩展和基此扩展的设计方案。并需要回答如下
- 问题
- 需要被换出的页的特征是什么?
-	只有映射到用户空间并且被用户程序直接访问的页面才能被交换,而被内核直接使用的内核空间的页面不能被换出.
在ucore中如何判断具有这样特征的页?
-	check_mm_struct变量这个数据结构表示了目前ucore认为合法的所有虚拟内存空间集合,而mm中的每个vma表示了一段地址连续的合法虚拟空间。当ucore或应用程序访问地址所在的页不在内存时,就会产生pagefault异常,引起调用do_pgfault函数,此函数会判断产生访问异常的地址属于check_mm_struct某个vma表示的合法虚拟地址空间,且保存在硬盘swap文件中(即对应的PTE的高24位不为0,而最低位为0)
- 何时进行换入和换出操作?
	ucore目前大致有两种策略,即积极换出策略和消极换出策略。积极换出策略是指操作系统周期性地(或在系统不忙的时候)主动把某些认为“不常用”的页换出到硬盘上,从而确保系统中总有一定数量的空闲页存在,这样当需要空闲页时,基本上能够及时满足需求;消极换出策略是指,只是当试图得到空闲页时,发现当前没有空闲的物理页可供分配,这时才开始查找“不常用”页面,并把一个或多个这样的页换出到硬盘上。
- 设计实现过程:
	map_swappable函数中只需将最近使用过的页面加入到队列最后即可.
	swap_out_vistim函数查找可交换的页面,只需取出最早到达队列的页面, 即使位于队列头部的页面, 将这个页面地址的地址赋给ptr_page变量即可.

